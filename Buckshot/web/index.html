<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Ranking global de Buckshot Roulette - El juego m√°s peligroso">
    <title>üé∞ Buckshot Roulette - Ranking Global</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="background-animation"></div>
    
    <div class="container">
        <!-- Header -->
        <header>
            <h1 class="title">üé∞ BUCKSHOT ROULETTE</h1>
            <p class="subtitle">El juego de la ruleta rusa con escopeta</p>
        </header>
        
        <!-- Estad√≠sticas Globales -->
        <section class="stats-section">
            <h2 class="section-title">üìä Estad√≠sticas Globales</h2>
            <div class="stats-grid" id="stats">
                <div class="stat-box">
                    <div class="stat-icon">üéÆ</div>
                    <div class="stat-label">Total Partidas</div>
                    <div class="stat-value" id="total-partidas">
                        <div class="loading-spinner"></div>
                    </div>
                </div>
                <div class="stat-box">
                    <div class="stat-icon">üìà</div>
                    <div class="stat-label">Promedio Puntos</div>
                    <div class="stat-value" id="promedio-puntos">
                        <div class="loading-spinner"></div>
                    </div>
                </div>
                <div class="stat-box">
                    <div class="stat-icon">üèÜ</div>
                    <div class="stat-label">R√©cord Mundial</div>
                    <div class="stat-value" id="max-puntos">
                        <div class="loading-spinner"></div>
                    </div>
                </div>
                <div class="stat-box">
                    <div class="stat-icon">üéØ</div>
                    <div class="stat-label">Puntuaci√≥n M√≠nima</div>
                    <div class="stat-value" id="min-puntos">
                        <div class="loading-spinner"></div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Ranking -->
        <section class="ranking-section">
            <h2 class="section-title">üèÜ TOP 10 RANKING GLOBAL</h2>
            <div id="ranking-lista" class="ranking-container">
                <div class="loading-message">
                    <div class="loading-spinner large"></div>
                    <p>Cargando ranking...</p>
                </div>
            </div>
        </section>
        
        <!-- Footer -->
        <footer>
            <p>üé≤ √öltima actualizaci√≥n: <span id="ultima-actualizacion">-</span></p>
            <p class="footer-note">
                Los datos se actualizan autom√°ticamente cada 30 segundos
            </p>
            <p class="footer-credits">
                Desarrollado con ‚ù§Ô∏è usando Python + Flask + PostgreSQL + Pygame
            </p>
        </footer>
        
        <!-- Mensaje de error -->
        <div id="error-message" class="error-message" style="display: none;">
            <div class="error-content">
                <span class="error-icon">‚ö†Ô∏è</span>
                <span class="error-text">Error al cargar datos del servidor</span>
                <button class="retry-button" onclick="cargarDatos()">Reintentar</button>
            </div>
        </div>
    </div>
    
    <script>
        let intervalId = null;
        
        // Funci√≥n para formatear fecha
        function formatearFecha(fecha) {
            const date = new Date(fecha);
            const opciones = { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            return date.toLocaleDateString('es-ES', opciones);
        }
        
        // Funci√≥n para obtener medalla seg√∫n posici√≥n
        function obtenerMedalla(posicion) {
            const medallas = {
                1: 'ü•á',
                2: 'ü•à',
                3: 'ü•â'
            };
            return medallas[posicion] || '';
        }
        
        // Funci√≥n para animar n√∫meros
        function animarNumero(elemento, valorFinal) {
            const valorInicial = 0;
            const duracion = 1000;
            const incremento = valorFinal / (duracion / 16);
            let valorActual = valorInicial;
            
            const intervalo = setInterval(() => {
                valorActual += incremento;
                if (valorActual >= valorFinal) {
                    valorActual = valorFinal;
                    clearInterval(intervalo);
                }
                elemento.textContent = Math.round(valorActual);
            }, 16);
        }
        
        // Cargar datos del servidor
        async function cargarDatos() {
            try {
                // Ocultar mensaje de error
                document.getElementById('error-message').style.display = 'none';
                
                // Cargar ranking
                const rankingRes = await fetch('/api/ranking?limite=10');
                if (!rankingRes.ok) throw new Error('Error al cargar ranking');
                const rankingData = await rankingRes.json();
                
                // Cargar estad√≠sticas
                const statsRes = await fetch('/api/estadisticas');
                if (!statsRes.ok) throw new Error('Error al cargar estad√≠sticas');
                const statsData = await statsRes.json();
                
                // Actualizar estad√≠sticas
                if (statsData.estadisticas) {
                    const stats = statsData.estadisticas;
                    
                    // Animar n√∫meros
                    const totalElem = document.getElementById('total-partidas');
                    const promedioElem = document.getElementById('promedio-puntos');
                    const maxElem = document.getElementById('max-puntos');
                    const minElem = document.getElementById('min-puntos');
                    
                    animarNumero(totalElem, stats.total_partidas || 0);
                    animarNumero(promedioElem, stats.promedio_puntos || 0);
                    animarNumero(maxElem, stats.max_puntos || 0);
                    animarNumero(minElem, stats.min_puntos || 0);
                }
                
                // Actualizar ranking
                const lista = document.getElementById('ranking-lista');
                if (rankingData.ranking && rankingData.ranking.length > 0) {
                    lista.innerHTML = rankingData.ranking.map((item, index) => {
                        const posicion = index + 1;
                        const medalla = obtenerMedalla(posicion);
                        const claseTop3 = posicion <= 3 ? 'top3' : '';
                        const clasePosicion = `pos-${posicion}`;
                        
                        return `
                            <div class="ranking-item ${claseTop3} ${clasePosicion}" style="animation-delay: ${index * 0.1}s">
                                <div class="ranking-pos">
                                    <span class="medal">${medalla}</span>
                                    <span class="number">${posicion}</span>
                                </div>
                                <div class="ranking-info">
                                    <div class="ranking-nombre">${item.nombre}</div>
                                    <div class="ranking-fecha">${formatearFecha(item.fecha)}</div>
                                </div>
                                <div class="ranking-puntos">
                                    <span class="puntos-valor">${item.puntos}</span>
                                    <span class="puntos-label">pts</span>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    lista.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üéÆ</div>
                            <p class="empty-text">No hay puntuaciones todav√≠a</p>
                            <p class="empty-subtext">¬°S√© el primero en jugar!</p>
                        </div>
                    `;
                }
                
                // Actualizar timestamp
                document.getElementById('ultima-actualizacion').textContent = 
                    new Date().toLocaleTimeString('es-ES');
                
            } catch (error) {
                console.error('Error al cargar datos:', error);
                
                // Mostrar mensaje de error
                document.getElementById('error-message').style.display = 'block';
                
                // Mostrar error en ranking
                document.getElementById('ranking-lista').innerHTML = `
                    <div class="error-state">
                        <div class="error-icon-large">‚ö†Ô∏è</div>
                        <p class="error-text-large">Error al conectar con el servidor</p>
                        <button class="retry-button" onclick="cargarDatos()">Reintentar</button>
                    </div>
                `;
            }
        }
        
        // Cargar datos al inicio
        cargarDatos();
        
        // Actualizar cada 30 segundos
        intervalId = setInterval(cargarDatos, 30000);
        
        // Limpiar intervalo al cerrar
        window.addEventListener('beforeunload', () => {
            if (intervalId) clearInterval(intervalId);
        });
    </script>
</body>
</html>
